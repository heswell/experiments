{
  "version": 3,
  "sources": ["../../src/handlers/authenticationHandler.ts"],
  "sourcesContent": ["import { uuid } from '../uuid.js';\nimport { TokenStore } from '../tokenStore.js';\n\n/**\n * @param {Object} options\n * @param {string} [options.name='']\n * @param {string} [options.value='']\n * @param {Date} [options.expires]\n * @param {number} [options.maxAge]\n * @param {string} [options.domain]\n * @param {string} [options.path]\n * @param {boolean} [options.secure]\n * @param {boolean} [options.httpOnly]\n * @param {'Strict'|'Lax'|'None'} [options.sameSite]\n * @return {string}\n */\nfunction createCookie(options) {\n  return (\n    `${options.name || ''}=${options.value || ''}` +\n    (options.expires != null ? `; Expires=${options.expires.toUTCString()}` : '') +\n    (options.maxAge != null ? `; Max-Age=${options.maxAge}` : '') +\n    (options.domain != null ? `; Domain=${options.domain}` : '') +\n    (options.path != null ? `; Path=${options.path}` : '') +\n    (options.httpOnly ? '; HttpOnly' : '') +\n    (options.sameSite != null ? `; SameSite=${options.sameSite}` : '') +\n    (options.secure ? '; Secure' : '')\n  );\n}\n\nexport function handleAuthenticationRequest(request, response) {\n  const { origin, 'access-control-request-headers': requestHeaders } = request.headers;\n  console.log(`origin = ${origin}`);\n  if (request.method === 'OPTIONS') {\n    const headers = {\n      'Access-Control-Allow-Credentials': true,\n      'Access-Control-Allow-Headers': requestHeaders,\n      'Access-Control-Allow-Origin': origin,\n      'Access-Control-Allow-Methods': 'OPTIONS, POST, GET',\n      'Access-Control-Max-Age': 14400 // 4 hours\n    };\n    response.writeHead(204, headers);\n    response.end();\n  } else {\n    let body = [];\n    request\n      .on('data', (chunk) => {\n        body.push(chunk);\n      })\n      .on('end', () => {\n        body = Buffer.concat(body).toString();\n        console.log(`got an auth request ${body}`);\n        const { username, password } = JSON.parse(body);\n        // DO wheverer we need to do here\n\n        const vuuAuthProp = 'vuu-auth-token';\n        const authToken = uuid();\n\n        TokenStore.setToken(authToken, { name: username });\n\n        const headers = {\n          'Access-Control-Allow-Credentials': true,\n          // 'Access-Control-Allow-Origin': 'http://localhost:5000'\n          'Access-Control-Allow-Origin': origin\n        };\n\n        var expiresTime = new Date();\n        const four_hours = 4 * 60 * 60 * 1000;\n        expiresTime.setTime(expiresTime.getTime() + four_hours);\n\n        headers[vuuAuthProp] = authToken;\n        const cookie = createCookie({\n          expires: expiresTime,\n          maxAge: 14400,\n          name: vuuAuthProp,\n          sameSite: 'None',\n          secure: true,\n          value: authToken\n        });\n        // should we push this here ?\n        headers['set-cookie'] = cookie;\n        console.log({ headers });\n        response.writeHead(201, headers);\n        response.end();\n      });\n  }\n}\n"],
  "mappings": "AAAA,SAAS,YAAY;AACrB,SAAS,kBAAkB;AAe3B,SAAS,aAAa,SAAS;AAC7B,SACE,GAAG,QAAQ,QAAQ,MAAM,QAAQ,SAAS,QACzC,QAAQ,WAAW,OAAO,aAAa,QAAQ,QAAQ,YAAY,MAAM,OACzE,QAAQ,UAAU,OAAO,aAAa,QAAQ,WAAW,OACzD,QAAQ,UAAU,OAAO,YAAY,QAAQ,WAAW,OACxD,QAAQ,QAAQ,OAAO,UAAU,QAAQ,SAAS,OAClD,QAAQ,WAAW,eAAe,OAClC,QAAQ,YAAY,OAAO,cAAc,QAAQ,aAAa,OAC9D,QAAQ,SAAS,aAAa;AAEnC;AAEO,SAAS,4BAA4B,SAAS,UAAU;AAC7D,QAAM,EAAE,QAAQ,kCAAkC,eAAe,IAAI,QAAQ;AAC7E,UAAQ,IAAI,YAAY,QAAQ;AAChC,MAAI,QAAQ,WAAW,WAAW;AAChC,UAAM,UAAU;AAAA,MACd,oCAAoC;AAAA,MACpC,gCAAgC;AAAA,MAChC,+BAA+B;AAAA,MAC/B,gCAAgC;AAAA,MAChC,0BAA0B;AAAA,IAC5B;AACA,aAAS,UAAU,KAAK,OAAO;AAC/B,aAAS,IAAI;AAAA,EACf,OAAO;AACL,QAAI,OAAO,CAAC;AACZ,YACG,GAAG,QAAQ,CAAC,UAAU;AACrB,WAAK,KAAK,KAAK;AAAA,IACjB,CAAC,EACA,GAAG,OAAO,MAAM;AACf,aAAO,OAAO,OAAO,IAAI,EAAE,SAAS;AACpC,cAAQ,IAAI,uBAAuB,MAAM;AACzC,YAAM,EAAE,UAAU,SAAS,IAAI,KAAK,MAAM,IAAI;AAG9C,YAAM,cAAc;AACpB,YAAM,YAAY,KAAK;AAEvB,iBAAW,SAAS,WAAW,EAAE,MAAM,SAAS,CAAC;AAEjD,YAAM,UAAU;AAAA,QACd,oCAAoC;AAAA,QAEpC,+BAA+B;AAAA,MACjC;AAEA,UAAI,cAAc,IAAI,KAAK;AAC3B,YAAM,aAAa,IAAI,KAAK,KAAK;AACjC,kBAAY,QAAQ,YAAY,QAAQ,IAAI,UAAU;AAEtD,cAAQ,eAAe;AACvB,YAAM,SAAS,aAAa;AAAA,QAC1B,SAAS;AAAA,QACT,QAAQ;AAAA,QACR,MAAM;AAAA,QACN,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,OAAO;AAAA,MACT,CAAC;AAED,cAAQ,gBAAgB;AACxB,cAAQ,IAAI,EAAE,QAAQ,CAAC;AACvB,eAAS,UAAU,KAAK,OAAO;AAC/B,eAAS,IAAI;AAAA,IACf,CAAC;AAAA,EACL;AACF;",
  "names": []
}
