import e,{isValidElement as t,cloneElement as n,useCallback as o,useRef as r,useEffect as l,createElement as i,useContext as s,forwardRef as c,useImperativeHandle as a,memo as u,useState as d,useReducer as m}from"react";import p from"classnames";import{rowUtils as h,columnUtils as g,DSC as f,ASC as y,groupHelpers as w,sortUtils as C,arrayUtils as E,filter as v,DataTypes as x}from"@heswell/data";import{createLogger as S,logColor as b}from"@heswell/utils";import{Motion as k,spring as _}from"react-motion";import{NumberFilter as I,SetFilter as N,MultiColumnFilter as L}from"@heswell/ingrid-extras";import D from"react-dom";import{ContextMenu as H,MenuItem as M,Separator as G,PopupService as R}from"@heswell/ui-controls";const T="ROWCOUNT",A="GROUP",O="SORT",W="SORT_GROUP",B="GRID_RESIZE",P="COLUMN_RESIZE_BEGIN",F="COLUMN_RESIZE",z="COLUMN_RESIZE_END",$="RESIZE_HEADING",V="TOGGLE",U="TOGGLE_FILTERS",X="SCROLL_LEFT",Y="SCROLL_RIGHT",q="GROUP_EXTEND",K={Checkbox:"checkbox",SingleRow:"single-row",MultipleRow:"multiple-row"},J={name:"string"};function Z(e){const{column:o,row:r}=e,{type:l=J,formatter:i}=o,s=r[o.key];return t(i)?n(i,e):i(s,l,r)}const j=e=>e.type?"string"==typeof e.type?e.type:e.type.name:null;function Q(e,t){return p("GridCell",e.className,j(e),e.resizing?"resizing":null,e.moving?"moving":null)}var ee=e.memo(({idx:t,column:n,row:r,onClick:l})=>{const i={width:n.width},s=(r[n.key],o(()=>{l(t)},[t,l]));return e.createElement("div",{className:Q(n),style:i,tabIndex:0,onClick:s},Z({column:n,row:r}))}),te=e.memo(({value:t,cellClass:n,column:o,row:r,meta:l})=>{const i=1===r[l.SELECTED];return e.createElement("div",{className:Q(o),style:{width:o.width},tabIndex:0},!h.isEmptyRow(r)&&e.createElement("div",{className:"checkbox"},e.createElement("i",{className:"material-icons"},i?"check_box_outline":"check_box_outline_blank")))});const ne=String.fromCharCode(11014),oe=String.fromCharCode(11015),re="up1",le="up2",ie="down1",se="down2",ce="arrow",ae="arrow-bg",ue=[null,null,null,null];function de(e,t,n){const o=r(),[i,s,c,a]=o.current||ue,u=e===i&&n===c&&Number.isFinite(s)&&Number.isFinite(t)?function(e,t,n,o){if(!Number.isFinite(n))return"";if(null!==t&&null!==n){let r=n-t;if(r){const{type:e}=o;let l=e&&e.formatting&&e.formatting.decimals;"number"==typeof l&&(r=+n.toFixed(l)-+t.toFixed(l))}if(r)return""===e?r<0?ie:re:r>0?e===ie||e===se||e===le?re:le:e===re||e===le||e===se?ie:se}}(a,s,t,n):"";return l(()=>{o.current=[e,t,n,u]}),u}var me=e.memo(t=>{const{column:n,row:o,meta:r}=t,{key:l,width:i,type:{renderer:{flashStyle:s}}}=n,c=o[l],a=de(o[r.KEY],c,n),u=s===ce||s===ae?a===re||a===le?ne:a===ie||a===se?oe:null:null,d=a?" "+a:"",m=s===ce?" arrow-only":s===ae?" arrow":"";return e.createElement("div",{className:`${Q(n)}${d}${m}`,style:{width:i}},e.createElement("div",{className:"flasher"},u),Z(t))});const pe="left",he="right",ge="none",fe="capitalize",ye={align:pe,capitalization:ge},we={formatting:ye};const Ce=String.fromCharCode(8200),Ee=String.fromCharCode(8199),ve=-1,xe={DIGIT:Ee,TWO_DIGITS:Ee+Ee,THREE_DIGITS:Ee+Ee+Ee,FULL_PADDING:[null,Ce+Ee,Ce+Ee+Ee,Ce+Ee+Ee+Ee,Ce+Ee+Ee+Ee+Ee]},Se=Ee+Ee+Ee+Ee+Ee+Ee+Ee+Ee+Ee,be={Right:"right",Center:"center",Left:"left"},ke={DIGIT:"0",TWO_DIGITS:"00",THREE_DIGITS:"000",FULL_PADDING:[null,".0",".00",".000",".0000"]};function _e(e,t=be.Right,n=4,o,r){if(void 0===e||"number"!=typeof e||isNaN(e))return"";let l,i,s;const[c,a=""]=e.toString().split("."),u=a.length;return l=parseFloat(c).toLocaleString(),t===be.Left&&r&&(l=function(e,t=6){return(Se+e).slice(-t)}(l)),l+((i=n===ve||u===n?a:u>n?parseFloat("0."+a).toFixed(n).slice(2):(s=o?ke:r&&t!==be.Left?xe:null)?0===u?s.FULL_PADDING[n]:function e(t,n,o){let r=t.length;const l=n-r;if(l>0)1===l?t+=o.DIGIT:2===l?t+=o.TWO_DIGITS:3===l&&(t+=o.THREE_DIGITS);else if(l<0&&(t=t.slice(0,n),r=n),o===xe&&"0"===t.charAt(r-1))return e(t=t.replace(/0+$/,""),n,o);return t}(a,n,s):a)?"."+i:"")}const Ie="right",Ne={align:Ie,decimals:ve},Le=(e,t)=>"number"==typeof e?e:t;var De=e.memo(({value:t,idx:n,cellClass:r,row:l,column:i,onClick:s,meta:c})=>{const a=o(e=>{e.preventDefault(),e.stopPropagation(),s(n)},[n,s]),u=l[c.DEPTH]>0;return e.createElement("div",{className:Q(i),style:{width:i.width},tabIndex:0},function(t,n,o,r,l){const i=t[o.COUNT],s=function(e,t,n){const o=Math.abs(e[n.DEPTH]);for(let n=0;n<t.length;n++){const r=t[n];if(r.groupLevel===o)return[e[r.key],n]}return null}(t,n,o);if(s){const[t,n]=s;return e.createElement("div",{className:"GroupCell",style:{paddingLeft:20*n},tabIndex:0,onClick:l},e.createElement("i",{className:"material-icons icon"},r?"expand_more":"chevron_right"),e.createElement("span",{className:"group-value"},t),e.createElement("span",null," (",i,")"))}}(l,i.columns,c,u,a))});const He={},Me={},Ge={formatter:e=>null==e?"":e,cellCSS:()=>""};function Re(e,t){He[e]=t}function Te(e,t){Me[e]=t}function Ae(e){const{column:t}=e,n=t&&t.type&&(t.type.renderer?t.type.renderer.name:t.type.name||null);let o;return n&&(o=Me[n])?i(o,e):t.isGroup?i(De,e):i(ee,e)}let Oe;function We(){if(void 0===Oe){let e=document.createElement("div");e.className="scrollable-content",e.style.width="50px",e.style.height="50px",e.style.overflowY="scroll",e.style.position="absolute",e.style.top="-200px",e.style.left="-200px";const t=document.createElement("div");t.style.height="100px",t.style.width="100%",e.appendChild(t),document.body.appendChild(e);const n=e.offsetWidth,o=t.offsetWidth;document.body.removeChild(e),Oe=n-o,e=null}return Oe}Te("selection-checkbox",te),Te("background",me),Re("number",class{static cellCSS({formatting:e=Ne}){const{align:t=Ie}=e;return t===Ie?Ie:""}static formatter(t,{formatting:n=Ne}){const{align:o,decimals:r,zeroPad:l,alignOnDecimals:i=!1}=n,s=Le(r,4),c="number"==typeof t?t:"string"==typeof t?parseFloat(t):null;return e.createElement("div",{className:"num"},_e(c,o,s,l,i))}}),Re("string",class{static cellCSS({formatting:e=ye}=we){const{align:t=pe,capitalization:n=ge}=e,o=[];return t===he&&o.push(he),n!==fe&&o.push(n),o.length?o.join(" "):""}static formatter(e){return e}});const{metaData:Be}=g;var Pe=(e,t)=>(Ye[t.type]||Ue)(e,t);const Fe={width:400,height:300,headerHeight:25,rowHeight:23,minColumnWidth:80,groupColumnWidth:"auto",columns:[],availableColumns:[],range:void 0,sortBy:void 0,groupBy:void 0,groupState:void 0,rowCount:0,scrollbarSize:15,scrollLeft:0,collapsedColumns:null,displayWidth:400,totalColumnWidth:0,selectionModel:K.MultipleRow,meta:null,_columns:null,_movingColumn:null,_groups:null,_overTheLine:0,_columnDragPlaceholder:null,_headingDepth:1,_headingResize:void 0},ze={resizing:!0},$e={resizing:!1},Ve=[],Ue=(e,t)=>(console.warn(`gridActionHandlers. No handler for action.type ${t.type}`),e),Xe=20,Ye={INITIALIZE:Ke,SUBSCRIBED:function(e,t){return console.log(`subscribed ${JSON.stringify(t.columns)}`),0===e.columns.length?Ke(e,{gridState:{columns:t.columns}}):e},[T]:function(e,{rowCount:t}){const{height:n,headerHeight:o,rowHeight:r,width:l,totalColumnWidth:i,scrollbarSize:s}=e;return ht(n-o,r*t,l,i,s)===e.displayWidth?e:Ke(e,{gridState:{rowCount:t}})},[O]:function(e,{column:t,direction:n,preserveExistingSort:o=!1}){const r=[[t.name,n||(1===t.sorted?f:y)]],l=null===e.sortBy||!0!==o?r:e.sortBy.concat(r);return Ke(e,{gridState:{sortBy:l}})},[W]:function(e,{column:t}){const{groupBy:n}=e;if(n){const o=w.indexOfCol(t.name,n);if(-1!==o){const[t,r]=n[o],l=r===y?[t,f]:[t,y],i=n.map((e,t)=>t===o?l:e);return Ke(e,{gridState:{groupBy:i}})}}return e},[A]:function(e,{column:t,rowCount:n=e.rowCount}){const o=[[t.name,y]];return Ke(e,{gridState:{groupBy:o,rowCount:n}})},[q]:function(e,{column:t,rowCount:n=e.rowCount}){const o=w.updateGroupBy(e.groupBy,t);return console.log(`modelReducer applyGroup new Group ${o}`),Ke(e,{gridState:{groupBy:o,rowCount:n}})},[P]:function(e,{column:t}){const{updatedGroups:n}=t.isHeading?et(e._groups,t,ze,ze,ze):tt(e._groups,t,ze);let o=t.isHeading?{lastSizedCol:0,...it(n,Je(t.key))}:void 0;return{...e,_groups:n,_headingResize:o}},[B]:function(e,{width:t,height:n}){return Ke(e,{gridState:{width:t,height:n}})},[F]:Ze,GROUP_COLUMN_WIDTH:function(e,{width:t}){return Ke(e,{gridState:{groupColumnWidth:t}})},[$]:function(e,{column:t,width:n}){if(n===t.width)return e;{const o=n-t.width,{lastSizedCol:r,groupIdx:l,groupColIdx:i}=e._headingResize,[s,c]=function(e,t,n){const o=n<0?-1:1,r=n*o,l=Math.min(r,t),i=Math.floor(r/t);let s=r%t;const c=[];for(let n=0;n<l;n++,e++)e===t&&(e=0),c[e]=o*(i+(s?1:0)),s&&(s-=1);return[e,c]}(r,i.length,o),a={lastSizedCol:s,groupIdx:l,groupColIdx:i};let u=e;for(let t=0;t<c.length;t++)if("number"==typeof c[t]){const n=e._groups[l].columns[i[t]];u=Ze({...u,_headingResize:a},{column:n,width:n.width+c[t]})}return u}},[z]:function(e,{column:t}){const n=t.isHeading?e.columns:function(e,t,n){return e.map(e=>e.name===t?{...e,...n}:e)}(e.columns,t.name,{width:t.width}),{updatedGroups:o}=t.isHeading?et(e._groups,t,$e,$e,$e):tt(e._groups,t,$e),r=t.isGroup?t.width:e.groupColumnWidth;return{...e,columns:n,_groups:o,groupColumnWidth:r,_headingResize:void 0}},MOVE_BEGIN:function(e,{column:t,scrollLeft:n=0}){const o=function(e,t){let n=0;for(let o=0;o<e.length;o++){const{columns:r}=e[o];for(let e=0;e<r.length;e++){if(r[e]===t)return n;n+=r[e].width}}return n}(e._groups,t),r=o-n,l=function(e){const t={left:[],right:[]};let n=0;for(let o=0;o<e.length;o++){const{columns:r}=e[o];for(let e=0;e<r.length;e++)t.left.push(n+20,o),n+=r[e].width,t.right.push(n-20,o)}return t}(e._groups),{updatedGroups:i,groupIdx:s,groupColIdx:c}=nt(e._groups,t,{key:"move-target",isPlaceHolder:!0,width:t.width,formatter:t.formatter}),a={...t,moving:!0,left:r,_virtualLeft:o,moveBoundaries:l,groupIdx:s,groupColIdx:c};return{...e,_groups:i,_movingColumn:a,_columnDragPlaceholder:{groupIdx:s,groupColIdx:c},scrollLeft:n}},MOVE:function(e,{distance:t,scrollLeft:n=0}){const o=e._movingColumn,r=o.left,l=e.displayWidth<e.totalColumnWidth,i=0===n?0:-Xe,s=e.displayWidth-o.width,c=s+(l?Xe:0),a=Math.min(c,Math.max(i,r+t)),u={...o,left:a,_virtualLeft:a+n},d=a>s,m=a<0?a:d?a-s:0;return je({...e,_overTheLine:m,_movingColumn:u},o)},MOVE_END:function(e,{column:t}){const{groupIdx:n,groupColIdx:o,moveBoundaries:r,left:l,...i}=e._movingColumn,{groupColIdx:s}=e._columnDragPlaceholder,{updatedGroups:c}=nt(e._groups,{key:"move-target"},i),a=function(e,t,n){const o=e.findIndex(e=>e.name===t.name),r=e.slice(),[l]=r.splice(o,1);return r.splice(n,0,l),r}(e.columns,t,s);return dt(c,e._headingDepth),{...e,columns:a,_groups:c,_movingColumn:null,_columnDragPlaceholder:null}},[V]:function(e,{groupRow:t}){const n=function(e,t){let{columns:n,columnMap:o,groupBy:r,groupState:l,meta:i}=t;const s=e[i.DEPTH],c=r.length-Math.abs(s),a=null===l?{}:{...l};let u=a;for(let t=0;t<=c;t++){const[l]=r[t],i=n.find(e=>e.name===l),s=o[i.name],a=e[s];if(t===c)u[a]?u[a]=null:u[a]=t===r.length-1||{};else if(!0===u[a])u=u[a]={};else if(!(u=u[a]={...u[a]}))return void console.log("Grid.toggleGroup something is wrong - trying to toggle a node whose parent is not expanded")}return a}(t,e);return{...e,groupState:n}},RANGE:function(e,{lo:t,hi:n}){const{range:o}=e;return o&&t===o.lo&&n===o.hi?e:{...e,range:{lo:t,hi:n}}},[X]:function(e,{scrollDistance:t}){const{_overTheLine:n,_movingColumn:o}=e,r=Math.max(e.scrollLeft+t,0);if(r===e.scrollLeft)return 0===n?e:{...e,_overTheLine:0};if(o){const t=o.left+r,n={...o,_virtualLeft:t};return je({...e,scrollLeft:r,_movingColumn:n},o)}return e},[Y]:function(e,{scrollDistance:t}){const{totalColumnWidth:n,displayWidth:o,_movingColumn:r,_overTheLine:l}=e,i=n-o,s=Math.min(e.scrollLeft+t,i);if(s===e.scrollLeft)return 0===l?e:{...e,_overTheLine:0};if(r){const t=r.left+s,n={...r,_virtualLeft:t};return je({...e,scrollLeft:s,_movingColumn:n},r)}return e},COLUMN_COLLAPSE:function(e,{column:t}){const n=null===e.collapsedColumns?[t.label]:e.collapsedColumns.concat(t.label);return Ke(e,{gridState:{collapsedColumns:n}})},COLUMN_EXPAND:function(e,{column:t}){const n=e.collapsedColumns.filter(e=>e!==t.label),o=0===n.length?null:n;return Ke(e,{gridState:{collapsedColumns:o}})},[void 0]:e=>(console.warn("gridActionHandlers. Invalid action:  missing attribute 'type'"),e)},qe=e=>Ke(Fe,{type:"INITIALIZE",gridState:e});function Ke(e,t){const{collapsedColumns:n=e.collapsedColumns,columns:o=e.columns,columnMap:r=null,groupBy:l=e.groupBy,groupColumnWidth:i=e.groupColumnWidth,groupState:s=e.groupState,height:c=e.height,headerHeight:a=e.headerHeight,minColumnWidth:u=e.minColumnWidth,rowHeight:d=e.rowHeight,range:m=e.range,rowCount:p=0,scrollbarSize:h=e.scrollbarSize,sortBy:f=e.sortBy,selectionModel:y=e.selectionModel,width:v=e.width}=t.gridState,x=y===K.Checkbox?[{name:"",width:25,sortable:!1,type:{name:"checkbox",renderer:{name:"selection-checkbox"}}}]:Ve,S=o.map(g.toKeyedColumn),b=x.concat(S.map(st)),[k,_]=function(e,t=null,n=Ve,o=null,r){const l=C.sortByToMap(t),i=[],s=0===e.length?0:Math.max(...e.map(({heading:e})=>Array.isArray(e)?e.length:1));let c=null;const[a,u]=function(e,t,n){if(t&&t.length>0){const o=({name:e})=>-1!==w.indexOfCol(e,t),[r,l]=E.partition(e,o);if(r.length!==t.length)throw Error(`extractGroupColumn: no column definition found for all groupBy cols ${JSON.stringify(t)} `);const i=t.length,s=t.map(([e],t)=>{return{...r.find(t=>t.name===e),groupLevel:i-t}});return[{key:-1,name:"group-col",isGroup:!0,columns:s,width:Math.max(...s.map(e=>e.width||n))+50},l]}return[null,e]}(e,n,r);if(a){const e=s>1?[]:void 0;i.push(c={locked:!1,columns:[a],headings:e,width:0,renderWidth:0,renderLeft:0}),pt(s,a,c.headings)}for(let e=0;e<u.length;e++){const t=u[e],{key:n,name:r,locked:a=!1}=t;if(null===c||c.locked!==a){const e=s>1?[]:void 0;i.push(c={locked:a,columns:[],headings:e,width:0,renderWidth:0,renderLeft:0})}const d=l[r];pt(s,t,c.headings,o);let{hidden:m}=t;if(c.headings){const e=c.headings.map(e=>e[e.length-1]).find(e=>e.collapsed);m=m||!!e,e&&e.key===n&&c.columns.push({key:e.key,isPlaceHolder:!0,width:25})}c.columns.push({...t,sorted:d,hidden:m})}return[i,s]}(b,f,l,n,u),I=ht(c-a,d*p,v,ut(b,u),h),N=function(e,t,n,o){if(0===e.length)return 0;const r=function(e){let t=[];return e.forEach(e=>{t=t.concat(e.columns)}),t}(e),[l]=r;o&&l.isGroup&&(l.width=Math.max("auto"===o?function(e){const{columns:t}=e;let n=document.createElement("div");n.className="Grid GroupbyHeaderCell",n.style.cssText="display:inline-block",n.innerText=t.map(e=>e.name).join(""),document.body.appendChild(n);const o=n.offsetWidth;return document.body.removeChild(n),n=null,o+50+50*(t.length-1)}(l):o,l.width));const i=r.filter(e=>!e.hidden),[s,c]=function(e,t,n=null){const o=[],r=[],l=null===n?null:[];for(let i=0;i<e.length;i++)t(e[i])?o.push(e[i]):null!==n&&n(e[i])?l.push(e[i]):r.push(e[i]);return null===n?[o,r]:[o,l,r]}(i,e=>void 0===e.width,e=>!e.hidden);let a=ut(c);const u=i.length-c.length,d=0===u?0:Math.max(Math.floor((t-a)/u),n);a+=u*d,s.forEach(e=>e.width=d);let m=0,p=0;e.forEach(e=>{e.width=ut(e.columns.filter(e=>!e.hidden)),e.locked&&(m+=e.width),e.headings&&(console.log(`group headings ${JSON.stringify(e.headings,null,2)}`),e.headings.forEach(t=>t.forEach(t=>{t.width=ut(lt(Je(t.key),e.columns).filter(e=>!e.hidden))})))}),t-m<n?(e=[{locked:!1,width:a,columns:r}],p=t):p=t-m;for(let t=0,n=0;n<e.length;n++){const o=e[n];o.renderLeft=t,o.renderWidth=o.locked?o.width:p,t+=o.renderWidth}return a}(k,I,u,i),L=null===r||o!==e.columns?g.buildColumnMap(o):r;return{...e,width:v,height:c,headerHeight:a,rowHeight:d,minColumnWidth:u,meta:Be(o),columns:S,columnMap:L,sortBy:f,groupBy:l,range:m,groupState:s,collapsedColumns:n,selectionModel:y,_headingDepth:_,_columns:b,_groups:k,totalColumnWidth:N,displayWidth:I}}const Je=e=>`${e}`.split(":").map(e=>parseInt(e,10));function Ze(e,{column:t,width:n}){if(t.width<=e.minColumnWidth&&n<=t.width)return e;const{updatedGroups:o,updatedGroup:r,groupIdx:l}=tt(e._groups,t,{width:n});!function(e){if(e.headings){const t=e.columns;e.headings=e.headings.map(e=>e.map(e=>{const n=rt(Je(e.key),t).reduce((e,n)=>e+t[n].width,0);return n===e.width?e:{...e,width:n}}))}}(r);const i=n-t.width,s=e.totalColumnWidth+i;if(e.displayWidth,r.width+=i,r.locked){r.renderWidth+=i;for(let e=l+1;e<o.length;e++){const{locked:t,renderLeft:n,renderWidth:r}=o[e];o[e]={...o[e],renderLeft:n+i,renderWidth:t?r:r-i}}}const c=t.isGroup?n:e.groupColumnWidth;return{...e,_groups:o,totalColumnWidth:s,groupColumnWidth:c}}function je(e,t){const n=e._movingColumn,{left:o,right:r}=n.moveBoundaries,{groupColIdx:l}=n;let i=-1,s=-1,c=0,a=0,u=0;if(t._virtualLeft>n._virtualLeft)for(let e=0,r=0;r<o.length&&-1===i;r+=2,e++){(s=o[r+1])!==u&&(a=c,u=s),c+=1;const d=e>l?n.width:0,m=o[r]-d;t._virtualLeft>=m&&n._virtualLeft<m&&(i=(d?e-1:e)-a)}else for(let e=0,o=0;o<r.length&&-1===i;o+=2,e++){(s=r[o+1])!==u&&(a=c,u=s),c+=1;const d=e<l?n.width:0,m=r[o]+d;t._virtualLeft+t.width<m&&n._virtualLeft+n.width>=m&&(i=(d?e+1:e)-a)}if(-1!==i){const{groupIdx:t,groupColIdx:n}=e._columnDragPlaceholder,o={groupIdx:s,groupColIdx:i},{updatedGroups:r}=function(e,t,n,o,r){const l=e[t].columns[n],i=e.slice();if(t===o){const e=Qe(i[t]);e.columns.splice(n,1),e.columns.splice(r,0,l),i[t]=e}else{const e=t>o;i[t]=function(e,t,n){const o=Qe(e),r=o.columns[t];o.columns.splice(t,1),o.width-=r.width,o.renderWidth-=r.width,n&&(o.renderLeft+=r.width);return o}(i[t],n,e),i[o]=function(e,t,n,o){const r=Qe(e);r.columns.splice(n,0,t),r.width+=t.width,r.renderWidth+=t.width,o||(r.renderLeft-=t.width);return r}(i[o],l,r,e)}return{updatedGroups:i}}(e._groups,t,n,s,i);return{...e,_groups:r,_columnDragPlaceholder:o}}return e}function Qe(e){return{...e,columns:[...e.columns]}}function et(e,t,n,o,r){const l=Je(t.key),{groupIdx:i,groupHeadingIdx:s,headingColIdx:c}=function(e,t){for(let n=0;n<e.length;n++){const{headings:o=null}=e[n];for(let e=0;o&&e<o.length;e++){const r=o[e].findIndex(e=>e.key===t.key&&e.label===t.label);if(-1!==r)return{groupIdx:n,groupHeadingIdx:e,headingColIdx:r}}}return{groupIdx:-1,groupHeadingIdx:-1,headingColIdx:-1}}(e,t),a=e[i],u={...a,headings:[...a.headings]},d=[...u.headings[s]];if(u.headings[s]=d,d[c]={...t,...n},o)for(let e=0;e<s;e++){const n=u.headings[e];let r=null;for(let e=0;e<n.length;e++)-1!==t.key.indexOf(n[e].key)&&((r=r||[...n])[e]={...n[e],...o});null!==r&&(u.headings[e]=r)}if(r){const{groupColIdx:t}=it(e,l);u.columns=[...a.columns],t.forEach(e=>{const t={...u.columns[e],...r};u.columns[e]=t})}const m=[...e];return m[i]=u,{updatedGroups:m,updatedGroup:u}}function tt(e,t,n){const{groupIdx:o,groupColIdx:r}=ot(e,t),l=e[o],i={...l,columns:[...l.columns]},s={...t,...n};i.columns[r]=s;const c=[...e];return c[o]=i,{updatedGroups:c,updatedGroup:i,updatedColumn:s,groupIdx:o,groupColIdx:r}}function nt(e,t,n){const{groupIdx:o,groupColIdx:r}=ot(e,t),l=e[o],i={...l,columns:[...l.columns]};i.columns[r]=n;const s=[...e];return s[o]=i,{updatedGroups:s,updatedGroup:i,groupIdx:o,groupColIdx:r}}function ot(e,t){for(let n=0;n<e.length;n++){const o=e[n].columns.findIndex(e=>e.key===t.key);if(-1!==o)return{groupIdx:n,groupColIdx:o}}return{groupIdx:-1,groupColIdx:-1}}const rt=(e,t)=>e.map(e=>t.findIndex(t=>t.key===e)),lt=(e,t)=>e.map(e=>t.find(t=>t.key===e));function it(e,t){for(let n=0;n<e.length;n++){const o=rt(t,e[n].columns);if(o.every(e=>-1!==e))return{groupIdx:n,groupColIdx:o}}return{groupIdx:-1,groupColIdx:[]}}function st(e){const{name:t,label:n=t}=e,o=function(e=null){const t=null===e?"string":"string"==typeof e?e:e.name;return He[t]?He[t]:Ge}(e.type);return{...e,label:e.heading?Array.isArray(e.heading)?e.heading[0]:e.heading:n,formatter:o.formatter,cellCSS:o.cellCSS(e.type)}}const ct=e=>t=>Math.max(t.width||0,e),at=(e,t)=>e+t;function ut(e,t=0){return 0===e.length?0:e.map(ct(t)).reduce(at)}function dt(e,t){return t>1&&e.forEach(e=>{const n=[];e.columns.forEach(e=>{pt(t,e,n)}),e.headings=n}),t}function mt(e,t){const n="string"==typeof e?e:e.toString();return!(t.length>=n.length)&&n.slice(-t.length)===t}function pt(e,t,n,o=null){const{key:r,heading:l=[t.name],width:i}=t;for(let t=1;t<e;t++){const s=n[t-1]||(n[t-1]=[]),c=l[t],a=s.length>0?s[s.length-1]:null;if(void 0!==c)if(a&&a.label===l[t])a.width+=i,a.key+=`:${r}`;else{const a=o&&-1!==o.indexOf(c);let u=!1;if(a)for(let e=0;e<t-1;e++){const t=n[e];t[t.length-1].hidden=!0}else if(t<e-1)for(let o=t;o<e;o++){const e=n[o],t=l[o+1];if(e&&e.length&&c){const{collapsed:n,hidden:o,label:r}=e[e.length-1];(n||o)&&r===t&&(u=!0)}}s.push({key:r,label:c,width:i,sortable:!1,collapsible:!0,collapsed:a,hidden:u,isHeading:!0})}else{const e=n[t-2],o=e?e[e.length-1]:null;o&&o.key===r?s.push({key:r,label:"",width:i,collapsed:o.collapsed,sortable:!1,isHeading:!0}):o&&mt(o.key,`:${r}`)?(a.width+=i,a.key+=`:${r}`):s.push({key:r,label:"",width:i,isHeading:!0})}}}function ht(e,t,n,o,r){const l=gt(o,n,r),i=gt(t,e,r);return"YES"===i?n-r:"NO"===i?n:"NO"===l?n:"YES"===l?n-r:"MAYBE"===l?n-r:void 0}function gt(e,t,n){return e>t?"YES":e<=t-n?"NO":"MAYBE"}function ft(){return(ft=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e}).apply(this,arguments)}const yt=()=>{};var wt=t=>{const{component:n,...l}=t,{onDrag:i,onDragStart:s=yt,onDragEnd:c=yt,children:a}=t,u=r({x:0,y:0}),d=r(null),m=e=>{const t=s(e);null===t&&0!==e.button||(u.current.x=e.clientX,u.current.y=e.clientY,window.addEventListener("mouseup",h),window.addEventListener("mousemove",p),d.current=t,e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault())},p=o(e=>{if(null===d.current)return;e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();const t=e.clientX,n=e.clientY,o=t-u.current.x,r=n-u.current.y;u.current.x=t,u.current.y=n,i(e,o,r)},[]),h=o(e=>{g(),c(e,d.drag),d.current=null},[]),g=()=>{window.removeEventListener("mouseup",h),window.removeEventListener("mousemove",p)};return a&&!Array.isArray(a)?e.cloneElement(a,{...l,onMouseDown:m}):n?e.createElement(n,ft({onMouseDown:m},l)):e.createElement("div",ft({onMouseDown:m},l))};const Ct="asc",Et="desc";var vt=({direction:t})=>t===Ct?e.createElement("i",{className:"material-icons"},"arrow_drop_up"):e.createElement("i",{className:"material-icons"},"arrow_drop_down"),xt=({column:t,multiColumnSort:n})=>{const{sortable:o,sorted:r,isPlaceHolder:l}=t;if(!1===o||l||!r)return null;const i=r<0?Et:Ct;return n?e.createElement("div",{className:`sort-col multi-col ${i}`},e.createElement(vt,{direction:i}),e.createElement("span",{className:"sort-col-num"},Math.abs(r))):e.createElement("div",{className:"sort-col single-col"},e.createElement(vt,{direction:i}))},St=e.createContext(null),bt=({column:t})=>{const{dispatch:n}=s(St);return!t.collapsible||t.isHidden?null:e.createElement("i",{className:"material-icons toggle-icon",onClick:()=>{const e=t.collapsed?"COLUMN_EXPAND":"COLUMN_COLLAPSE";n({type:e,column:t})}},"arrow_right")};const kt=({column:e})=>e.collapsed||e.hidden?"":e.label||"";var _t=({className:t,column:n,multiColumnSort:i,onClick:s=(()=>{}),onResize:c,onMove:a,onContextMenu:u})=>{const d=r(!1),m=r(!1),h=r(n),g=r(null),f=r({x:0,y:0});l(()=>{h.current=n},[n]);const y=o(()=>{C(),d.current&&(m.current=!0,a("end",h.current))},[]),w=o(e=>{console.log("onMouseMove"),e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault();const t=e.clientX,n=e.clientY,o=t-f.current.x;d.current?(f.current.x=t,f.current.y=n,a("move",h.current,o)):Math.abs(o)>3&&(d.current=!0,f.current.x=t,f.current.y=n,a("begin",h.current,o))},[]),C=()=>{window.removeEventListener("mouseup",y),window.removeEventListener("mousemove",w)},E=o(e=>{const t=v(e);t>0&&(console.log(`resize ${t} resizing ? ${h.resizing}`),c("resize",h.current,t))},[]),v=e=>{return e.pageX-g.current.getBoundingClientRect().left},x=p("HeaderCell",n.className,n.cellCSS,t,{"HeaderCell--resizing":n.resizing,hidden:n.hidden,collapsed:n.collapsed}),S={width:n.width};return n.hidden&&0===n.width&&(S.display="none"),e.createElement("div",{ref:g,className:x,style:S,onClick:()=>{m.current?m.current=!1:s(h.current)},onMouseDown:e=>{f.current={x:e.clientX,y:e.clientY},window.addEventListener("mouseup",y),window.addEventListener("mousemove",w)},onContextMenu:e=>{u(e,"header",{column:h.current})}},e.createElement(xt,{column:n,multiColumnSort:i}),e.createElement(bt,{column:n}),e.createElement("div",{className:"InnerHeaderCell"},e.createElement("div",{className:"cell-wrapper"},e.createElement(kt,{column:n}))),!1!==n.resizeable&&e.createElement(wt,{className:"resizeHandle",onDrag:E,onDragStart:()=>c("begin",h.current),onDragEnd:e=>{m.current=!0;const t=v(e);c("end",h.current,t)}}))};const It=t=>{const{column:n,className:o,onClick:r,onRemoveColumn:l,expandState:i,onToggle:s}=t,c=1===i;return e.createElement("div",{className:p("ColHeader",o,{expanded:c,collapsed:!c})},e.createElement("i",{className:"material-icons toggle-icon",onClick:()=>s(n,-i)},c?"expand_more":"chevron_right"),e.createElement("span",{className:"ColHeaderLabel",onClick:()=>r(n)},n.name),e.createElement("i",{className:"material-icons remove-icon",onClick:()=>l(n)},"cancel"))};var Nt=({className:t,column:n,groupState:i,onClick:s,onContextMenu:c,onRemoveColumn:a,onResize:u,onToggleGroupState:d})=>{const m=r(null),h=r(n);l(()=>{h.current=n},[n]);const g=()=>{s(n)},f=o(e=>{const t=y(e);t>0&&u("resize",h.current,t)},[]),y=e=>{return e.pageX-m.current.getBoundingClientRect().left},{columns:w,resizing:C,width:E}=n,v=p("GroupHeaderCell","HeaderCell group",t,C?"HeaderCell--resizing":""),x=function({columns:e},t){const n=Array(e.length).fill(-1);let o=t&&t["*"];for(;o;)n[0]=1,o=o["*"];return n}(n,i);return e.createElement("div",{ref:m,className:v,style:{paddingLeft:0,width:E},onContextMenu:e=>{c(e,"header",{column:n})}},e.createElement("div",{className:"inner-container"},w.map((t,n)=>e.createElement(It,{key:t.key,column:t,expandState:x[n],onClick:g,onRemoveColumn:a,onToggle:d,className:Lt(w,n)}))),e.createElement(wt,{className:"resizeHandle",onDrag:f,onDragStart:()=>u("begin",h.current),onDragEnd:e=>{const t=y(e);u("end",h.current,t)}}))};function Lt(e,t){const n=[];return 0===t&&n.push("first"),t===e.length-1&&n.push("last"),n.join(" ")}var Dt=c((function({columnGroup:t,colGroupHeaderRenderer:n,colHeaderRenderer:l,ignoreHeadings:i,model:c,onColumnMove:u},d){const{dispatch:m,showContextMenu:h}=s(St),g=r(null);a(d,()=>({scrollLeft:e=>{g.current.scrollLeft=e}}));const f=o((e,t,n)=>{"resize"===e?t.isHeading?m({type:$,column:t,width:n}):m({type:F,column:t,width:n}):"begin"===e?m({type:P,column:t}):"end"===e&&m({type:z,column:t})},[]),y=o(e=>{m({type:q,column:e})},[]),w=e=>{!1!==e.sortable&&m({type:O,column:e})},C=o((e,t)=>{m({type:V,groupState:1===t?{"*":!0}:{}})},[]),E=t=>{const o=n;return e.isValidElement(o)?e.cloneElement(o,t):o&&o(t)||e.createElement(Nt,t)},v=t=>{const n=l;return e.isValidElement(n)?e.cloneElement(n,t):n&&n(t)||e.createElement(_t,t)},x=o(e=>{!1!==e.sortable&&m({type:W,column:e})},[]),{width:S,renderWidth:b,renderLeft:k,headings:_=[]}=t;return e.createElement("div",{ref:g,className:"ColumnGroupHeader",style:{width:b,left:k}},!i&&_.map((t,n)=>e.createElement("div",{className:"group-heading",key:n,style:{width:S}},(t=>t.map((t,n)=>e.createElement(_t,{key:n,className:p("colgroup-header",{bottomless:""===t.label}),column:t,onResize:f,onMove:u,onContextMenu:h})))(t))).reverse(),e.createElement("div",{className:"header-cells",style:{whiteSpace:"nowrap",width:S,position:"relative"}},(()=>t.columns.filter(e=>!e.hidden).map(e=>{const t={key:e.key,column:e,onResize:f,onMove:u,onContextMenu:h},n=c.sortBy&&c.sortBy.length>1;return e.isGroup?E({...t,groupState:c.groupState,onClick:x,onToggleGroupState:C,onRemoveColumn:y}):v({...t,value:e.name,multiColumnSort:n,onClick:w})}))()))}));var Ht=u(c(({className:t,colGroupHeaderRenderer:n,colHeaderRenderer:o,height:l,ignoreHeadings:i=!1,model:c,style:u},d)=>{const{dispatch:m}=s(St),h=r(null),g=r(0);a(d,()=>({scrollLeft:e=>{g.current=e,h.current.scrollLeft(e)}}));const f=(e,t,n)=>{if(!t.isHeading){const o=g.current;"move"===e&&0!==n?m({type:"MOVE",distance:n,scrollLeft:o}):"begin"===e?m({type:"MOVE_BEGIN",column:t,scrollLeft:o}):"end"===e&&m({type:"MOVE_END",column:t})}},y=p("Header",t),w={...u,height:l};return e.createElement("div",{className:y,style:w},c._groups.map((t,r)=>e.createElement(Dt,{key:r,ref:t.locked?null:h,columnGroup:t,model:c,ignoreHeadings:i,onColumnMove:f,colHeaderRenderer:o,colGroupHeaderRenderer:n})))}));let Mt=!1;const Gt=[];function Rt(e){27===e.keyCode&&(Gt.length?(At(),console.log("unmount the open popup(s)")):Mt&&(console.log("unmount the open dialog"),D.unmountComponentAtNode(document.body.querySelector(".react-dialog"))))}function Tt(e){if(Gt.length){const t=document.body.querySelectorAll(".react-popup");for(let n=0;n<t.length;n++)if(t[n].contains(e.target))return;console.log("close all popups"),At()}}function At(){if(Gt.length){const e=document.body.querySelectorAll(".react-popup");for(let t=0;t<e.length;t++)console.log("unmountComponentAtNode"),D.unmountComponentAtNode(e[t]);Ot("*")}}function Ot(e){if(Gt.length){if("*"===e)Gt.length=0;else{const t=Gt.indexOf(e);-1!==t&&Gt.splice(t,1)}0===Gt.length&&!1===Mt&&(window.removeEventListener("keydown",Rt,!0),window.removeEventListener("click",Tt,!0))}}class Wt{static showPopup({name:t="anon",group:n="all",position:o="",left:r=0,top:l=0,width:i="auto",component:s}){!function(e){-1===Gt.indexOf(e)&&(Gt.push(e),!1===Mt&&(window.addEventListener("keydown",Rt,!0),window.addEventListener("click",Tt,!0)))}(t);let c=document.body.querySelector(".react-popup."+n);null===c&&((c=document.createElement("div")).className="react-popup "+n,document.body.appendChild(c));const a=p("popup-container",o);D.render(e.createElement("div",{className:a,style:{position:"absolute",left:r,top:l,width:i}},s," "),c,()=>{Wt.keepWithinThePage(c)})}static hidePopup(e="anon",t="all"){-1!==Gt.indexOf(e)&&(Ot(e),D.unmountComponentAtNode(document.body.querySelector(`.react-popup.${t}`)))}static movePopup(e,t,n="anon",o="all"){const r=document.querySelector(`.react-popup.${o} .popup-container`);r.style.top=parseInt(r.style.top,10)+t+"px",r.style.left=parseInt(r.style.left,10)+e+"px"}static keepWithinThePage(e){const t=e.querySelector(".popup-container"),{top:n,left:o,width:r,height:l}=t.firstChild.getBoundingClientRect(),i=window.innerWidth,s=window.innerHeight-(n+l);s<0&&(t.style.top=parseInt(t.style.top,10)+s+"px");const c=i-(o+r);c<0&&(t.style.left=parseInt(t.style.left,10)+c+"px")}}e.Component;var Bt=({column:t,dataView:n,filter:i,onClearFilter:s,onFilterOpen:c,onFilterClose:a,showFilter:u,onFilter:d})=>{const m=r(null),h=()=>{Wt.hidePopup()},f=o(()=>{setTimeout(()=>{a()},50)},[]),y=o(e=>{13===e.keyCode&&n.filter({type:v.STARTS_WITH,colName:t.name,value:e.target.value})},[]),w=o(()=>{s(t)},[]),C=(e,t)=>{d(e,t)},E=()=>{};l(()=>{if(u){const e=S(),t=m.current,{left:n,top:o}=t.getBoundingClientRect();requestAnimationFrame(()=>{Wt.showPopup({left:Math.round(n),top:o-26,component:e})})}},[u]);const x=(e,t,n)=>{console.log(`move Filter by ${t} ${n}`),Wt.movePopup(t,n)},S=()=>{if(console.log(`getFilter ${JSON.stringify(t)}`),t.isGroup&&1!==t.columns.length)return e.createElement(L,{column:t,height:261,width:300,filter:i,dataView:n,onHide:f,onClose:h,onApplyFilter:E});switch(g.getFilterType(t)){case"number":return e.createElement(I,{column:t,height:250,className:"FilterPanel",dataView:n,filter:i,onHide:f,onClose:h,onApplyFilter:C});default:return e.createElement(wt,{onDrag:x},e.createElement(N,{className:"FilterPanel",column:t,filter:i,height:350,width:t.width+120,dataView:n,onHide:f,onClose:h}))}},b=v.includesColumn(i,t),k=p("HeaderCell",{"filter-active":b,"filter-showing":u});return e.createElement("div",{ref:m,className:k,style:{padding:0,width:t.width}},e.createElement("div",{className:"filter-button",onClick:()=>{c(t)}},e.createElement("i",{className:"material-icons"},"filter_list")),e.createElement("div",{className:"filter-input-container"},e.createElement("input",{className:"filter-input",type:"text",onKeyDown:y})),b&&e.createElement("div",{className:"filter-clear-button",onClick:w},e.createElement("i",{className:"material-icons"},"cancel")))};const{STARTS_WITH:Pt,NOT_IN:Ft}=v;var zt=c(({dataView:t,height:n,model:l,filter:i,style:s},c)=>{const u=r(null),[m,p]=d(null);a(c,()=>({scrollLeft:e=>{u.current.scrollLeft(e)}}));const h=e=>{const{key:n,name:o}=e.isGroup?e.columns[0]:e;m!==o&&(t.getFilterData({key:n,name:o}),p(e.name))},g=()=>{p(null),t.setFilterRange(0,0)},f=(e,n)=>{const o=v.addFilter(i,n);if(console.log(`\n                add filter ${JSON.stringify(n,null,2)}\n                to filter ${JSON.stringify(i,null,2)}\n                creates new filter = ${JSON.stringify(o,null,2)}\n            `),t.filter(o),n.isNumeric){const{key:n,name:o}=e.isGroup?e.columns[0]:e;t.getFilterData({key:n,name:o})}},y=o(e=>{t.filter({type:Ft,colName:e.name,values:[]},x.ROW_DATA,!0)},[]),w=({key:n,column:o})=>e.createElement(Bt,{key:n,column:o,dataView:t,filter:i,onClearFilter:y,onFilterOpen:h,onFilterClose:g,showFilter:m===o.name,onFilter:f});return e.createElement(Ht,{className:"InlineFilter",ref:u,model:l,height:n,style:s,ignoreHeadings:!0,colGroupHeaderRenderer:w,colHeaderRenderer:w})}),$t=e.memo(({row:t,idx:n,columns:r,gridModel:l})=>{const{meta:i,rowHeight:c}=l,a=o(e=>m(e,"row",{idx:n,row:t}),[n,t]),{dispatch:u,callbackPropsDispatch:d,showContextMenu:m}=s(St),h=o(e=>{const o=e.shiftKey,r=e.ctrlKey||e.metaKey;console.log("Row about to call callbackPropsDIspatch('selection')"),d({type:"selection",idx:n,row:t,rangeSelect:o,keepExistingSelection:r})},[n,t]),g=o(()=>d({type:"double-click",idx:n,row:t}),[n,t]),f=o(e=>{w&&u({type:V,groupRow:t}),d({type:"select-cell",idx:n,cellIdx:e})},[n,t]),y=t[i.DEPTH],w=0!==y,C=1===t[i.SELECTED],E=p("GridRow",n%2==0?"even":"odd",{selected:C,group:w,collapsed:w&&y<0,expanded:w&&y>=0}),v=r.filter(e=>!e.hidden).map((n,o)=>{const r={key:o,idx:o,column:n,meta:i,row:t,onClick:f};return e.isValidElement(n.renderer)?e.cloneElement(n.renderer,r):n.renderer&&n.renderer(r)||Ae(r)});return e.createElement("div",{className:E,tabIndex:0,style:{transform:`translate3d(0px, ${n*c}px, 0px)`},onClick:h,onDoubleClick:g,onContextMenu:a},v)});const Vt=([e],[t])=>e-t,Ut={position:"absolute",top:0,overflow:"hidden"},Xt={position:"absolute",overflow:"hidden"};var Yt=c((function({columnGroup:t,firstVisibleRow:n,gridModel:o,height:l,rows:i,onKeyDown:c},u){const d=r(null),{showContextMenu:m}=s(St);a(u,()=>({scrollLeft:e=>{d.current.style.left=`-${e}px`}}));const{renderLeft:h,renderWidth:g}=t,{RENDER_IDX:f}=o.meta,y=i.map((e,t)=>{const o=n+t;return[e[f],o,e]}).sort(Vt).map(([n,r,l])=>e.createElement($t,{key:n,idx:r,row:l,gridModel:o,columns:t.columns})),w=p("Canvas",{fixed:t.locked});return e.createElement("div",{style:{...Ut,left:h,width:g,height:l},className:w,onContextMenu:e=>{m(e,"canvas")},onKeyDown:c},e.createElement("div",{ref:d,style:{...Xt,width:Math.max(t.width,g),height:l}},y))}));const qt=()=>{},Kt=t=>{const{rows:n,gridModel:o}=t,{_movingColumn:r,meta:l,headerHeight:i,_headingDepth:s}=o,{left:c,width:a}=r,u=(s-1)*i;return console.log("render ColumnBearer"),e.createElement("div",{className:"ColumnBearer",style:{top:u,left:c,width:a}},e.createElement("div",{className:"Header",style:{height:i}},e.createElement(_t,{column:r})),n.map((t,n)=>e.createElement("div",{key:n,className:"Row"},Ae({idx:n,column:r,meta:l,formatter:r.formatter||qt,row:t,value:t[r.key]}))))},Jt={lo:0,hi:-1},Zt={rows:[],rowCount:0,range:Jt,offset:0,_keys:{free:[],used:{}}};function jt(e){return(t,n)=>"range"===n.type?function(e,{range:t},n){const{rows:o,rowCount:r,offset:l}=e,i=function(e,{lo:t,hi:n}){const o=[],r=n-t;for(let t=0;t<r;t++){const n=e.used[t];3!==n&&void 0!==n||o.push(t)}return{used:e.used,free:o}}(e._keys,t),[s,c]=0===o.length?[o,i]:en(t,o,l,[],r,n,i);return{rows:s,rowCount:r,offset:l,range:t,_keys:c}}(t,n,e.meta):"data"===n.type?function(e,t,n){const{rows:o,rowCount:r,offset:l}=t,i=t.range.reset||e.range===Jt?t.range:e.range,[s,c]=en(i,e.rows,l,o,r,n,e._keys);return{rows:s,rowCount:r,offset:l,range:i,_keys:c}}(t,n,e.meta):"update"===n.type?function(e,t,n){const o=h.update(e.rows,t.updates,n);return{...e,rows:o}}(t,n,e.meta):"selected"===n.type?function(e,{selected:t,deselected:n},o){const{IDX:r,SELECTED:l}=o,{rows:i,rowCount:s}=e,c=[];for(let e=0;e<i.length;e++){const o=i[e],s=o[r],a=o[l],u=!a&&t.includes(s-100),d=a&&n.includes(s-100);if(u||d){const t=o.slice();t[l]=u?1:0,c[e]=t}else c[e]=o}return{...e,rows:c,rowCount:s}}(t,n,e.meta):n.type===T?function(e,{rowCount:t}){return{...e,rowCount:t}}(t,n):void 0}function Qt(e,{IDX:t,count:n}){const o=Array(n);return o[t]=e,o}function en({lo:e,hi:t},n,o=0,r,l,i,s){const{IDX:c,RENDER_IDX:a}=i,{free:u,used:d}=s,m=e+o,p=Math.min(t+o,l+o),h=t-e,g=[],f={},y=u.slice();let w,C,E,v,x=n.length;for(let e=0;e<n.length;e++)(C=n[e])&&(w=(E=C[c])-m,1===d[v=C[a]]&&E>=m&&E<p?(g[w]=n[e],f[v]=1):1===d[v]&&v<h&&(y.push(v),f[v]=void 0));for(let e=0;e<r.length;e++)(C=r[e])&&(w=(E=C[c])-m,E>=m&&E<p?(g[w]?v=g[w][a]:(void 0===(v=y.shift())&&(v=x++),f[v]=1),g[w]=C,C[a]=v):console.warn("new row outside range"));for(let e=0,t=0;e<h;e++)if(void 0===g[e]){const n=g[e]=Qt(e+m,i);v=y[t++],n[a]=v,f[v]=3}return[g,{free:y,used:f}]}S("Viewport",b.green);const tn=We(),nn={position:"absolute",top:25,left:0,right:0,bottom:0,padding:0,overflow:"hidden"},on={position:"absolute",top:0,left:0,right:0,padding:0};const rn=e.memo(({style:t,height:n,dataView:i,model:c,onFilterChange:a})=>{const u=r(null),d=r(null),p=r(null),h=r(0),g=r(0),f=r(c.groupBy),y=r(c.rowCount),{dispatch:w,callbackPropsDispatch:C}=s(St),[E,v]=m(jt(c),Zt);l(()=>{y.current=c.rowCount},[c.rowCount]),l(()=>{const e=Math.ceil(n/c.rowHeight)+1;return i.subscribe({columns:c.columns,range:{lo:0,hi:e}},e=>{e.range&&e.range.reset&&b(0),void 0!==e.filter&&a(e.filter),"number"==typeof e.size&&e.size!==y.current&&(w({type:T,rowCount:e.size}),v({type:T,rowCount:e.size})),e.rows?v({type:"data",rows:e.rows,rowCount:e.size,offset:e.offset,range:e.range}):e.updates?v({type:"update",updates:e.updates,range:e.range}):e.selected?v({type:"selected",selected:e.selected,deselected:e.deselected}):"subscribed"===e.type&&w({type:"SUBSCRIBED",columns:e.columns,availableColumns:e.availableColumns})}),()=>i.unsubscribe()},[i]),l(()=>{const e=Math.ceil(n/c.rowHeight)+1;if(e!==c.rowCount){w({type:T,rowCount:e});const t=g.current;k(t,t+e)}},[n]);const x=function(e){const t=r(null),n=r(null),l=r(null),i=()=>{l.current!==n.current?(e(l.current),n.current=l.current,t.current=requestAnimationFrame(i)):t.current=null};return o(e=>{l.current=e.target.scrollTop,null===t.current&&(t.current=requestAnimationFrame(i))},[e])}(o(e=>{h.current=e;const t=Math.floor(e/c.rowHeight);if(t!==g.current){const e=Math.ceil(n/c.rowHeight)+1;g.current=t,k(t,t+e)}},[])),S=o(e=>{if(e.target===e.currentTarget){const t=e.target.scrollLeft;u.current.scrollLeft(t),C({type:"scroll",scrollLeft:t})}},[]),b=o(e=>{p.current.scrollTop=h.current=e},[]),k=o((e,t)=>{v({type:"range",range:{lo:e,hi:t}}),i.setRange(e,t)},[]),_=c.totalColumnWidth>c.displayWidth,I=_?n-15:n,N=Math.max(c.rowHeight*E.rowCount,I),L=(N>n?c.width-tn:c.width)===c.width?"hidden":"auto";let D=f.current===c.groupBy?null:(f.current=c.groupBy,[]);return e.createElement(e.Fragment,null,e.createElement("div",{className:"Viewport",style:{...nn,...t}},_&&c._groups.filter(e=>!e.locked).map((t,n)=>e.createElement("div",{className:"CanvasScroller horizontal scrollable-content",ref:d,key:n,style:{left:t.renderLeft,width:t.renderWidth},onScroll:S},e.createElement("div",{className:"CanvasScroller-content",style:{width:t.width,height:15}}))),e.createElement("div",{className:"ViewportContent scrollable-content",ref:p,style:{...on,bottom:_?15:0,overflow:L},onScroll:x},e.createElement("div",{className:"scrolling-canvas-container",style:{width:c.displayWidth,height:N}},c._groups.map((t,n)=>e.createElement(Yt,{key:n,gridModel:c,rows:D||E.rows,firstVisibleRow:g.current,height:N,ref:t.locked?null:u,columnGroup:t}))))),c._movingColumn&&e.createElement(Kt,{gridModel:c,rows:E.rows}))});var ln=(e,t,n,o)=>(r,l)=>{const{type:i,...s}=l;if(console.log(`%cgridReducer ${i}`,"color:blue;font-weight: bold;"),"scroll"===i)e&&e(s);else if("selection"===i){const{idx:e,row:n,rangeSelect:o,keepExistingSelection:r}=l;t(e,n,o,r)}else if("select-cell"===i){const{idx:e,cellIdx:t}=l;n&&n(e,t)}else if("double-click"===i){const{idx:e,row:t}=l;o&&o(e,t)}return r};const sn={SortAscending:"sort-asc",SortAddAscending:"sort-add-asc",SortDescending:"sort-dsc",SortAddDescending:"sort-add-dsc",GroupBy:"groupby",GroupByReplace:"groupby-replace"};class cn extends e.Component{handleMenuAction(e,t){const{dispatch:n,doAction:o}=this.props;switch(e){case sn.GroupBy:n({type:q,column:t.column});break;case sn.GroupByReplace:n({type:A,column:t.column});break;case sn.SortAscending:return this.sort(t.column,"asc");case sn.SortDescending:return this.sort(t.column,"dsc");case sn.SortAddAscending:return this.sort(t.column,"asc",!0);case sn.SortAddDescending:return this.sort(t.column,"dsc",!0);default:o(e,t)}}sort(e,t=null,n=!1){const{dispatch:o}=this.props;o({type:O,column:e,direction:t,preserveExistingSort:n})}render(){const{location:t,options:n}=this.props;return(e.createElement(H,{doAction:(e,t)=>this.handleMenuAction(e,t)},this.menuItems(t,n)))}menuItems(t,n){const o=[];if("header"===t){const{model:t,column:{name:r,sorted:l,isGroup:i}}=n,{groupBy:s,sortBy:c}=t;l?(c&&c.length>1&&o.push(e.createElement(M,{key:"sort-remove",action:"sort-remove",data:n,label:"Remove from Sort"})),1===l?o.push(e.createElement(M,{key:"sort-asc",action:"sort-dsc",data:n,label:"Sort (DESC)"})):o.push(e.createElement(M,{key:"sort-dsc",action:"sort-asc",data:n,label:"Sort (ASC)"}))):(o.push(e.createElement(M,{key:"sort-asc",action:"sort-asc",data:n,label:"Sort"},e.createElement(M,{key:"sort-asc",action:"sort-asc",data:n,label:"ASC"}),e.createElement(M,{key:"sort-dsc",action:"sort-dsc",data:n,label:"DESC"}))),c&&c.length&&o.push(e.createElement(M,{key:"sort-add-asc",action:"sort-add-asc",data:n,label:"Add to Sort"},e.createElement(M,{key:"sort-add-asc",action:"sort-add-asc",data:n,label:"ASC"}),e.createElement(M,{key:"sort-add-dsc",action:"sort-add-dsc",data:n,label:"DESC"})))),s&&s.length?i||o.push(e.createElement(M,{key:"groupby-add",action:"groupby",data:n,label:`Add ${r} to Group`})):o.push(e.createElement(M,{key:"groupby-add",action:"groupby",data:n,label:`Group by ${r}`}))}else"row"===t&&o.push(e.createElement(M,{key:"delete-row",action:"delete-row",label:"Delete Row"}));return o.push(e.createElement(G,{key:"1"})),n.showFilters?o.push(e.createElement(M,{key:"hide-filters",action:U,label:"Hide Filters"})):o.push(e.createElement(M,{key:"show-filters",action:U,label:"Column Filters"})),o.push(e.createElement(M,{key:"settings",action:"settings",label:"Settings"})),o}}const an=(t,n,r,l)=>{const i=o(e=>{e===U&&r(e=>!e)},[n]);return o((o,r,s)=>{o.preventDefault(),o.stopPropagation();const{clientX:c,clientY:a}=o,u=e.createElement(cn,{location:r,options:{...s,model:t,showFilters:n},dispatch:l,doAction:i});R.showPopup({left:Math.round(c),top:Math.round(a),component:u})},[t,n])},un=S("Grid",b.green),dn=We();function mn({dataView:t,columns:n=[],style:i,showHeaders:s=!0,headerHeight:c=(s?24:0),showFilters:a=!1,onScroll:u,onSelectCell:h=(()=>{}),onSingleSelect:g,onSelectionChange:f,onDoubleClick:y,...w}){const C=r(null),E=r(null),v=r(0),x=r(0),S=w.width||i.width,b=w.height||i.height,[I,N]=d(a),[L,D]=d(null),H=o(e=>{const{scrollLeft:t=-1}=e;-1!==t&&v.current!==t&&(v.current=t,C.current&&C.current.scrollLeft(t),E.current&&E.current.scrollLeft(t)),u&&u(e)},[]),M=o((e,n,o,r)=>{if(t.select(e,n,o,r),f){const t=1===n[R.meta.SELECTED];f&&f(e,n,!t)}},[]),[,G]=m(o(ln(H,M,h,y),[]),null),[R,T]=m(Pe,{...w,columns:n,scrollbarSize:dn,headerHeight:c},qe),A=an(R,I,N,T),{height:O,width:W,_headingDepth:P,groupBy:F,groupState:z,sortBy:$,_overTheLine:V}=R;l(()=>{x.current=V,un.log("<useEffect _overTheLine>");const e=()=>{if(0!==x.current){const t=x.current>0?Y:X;T({type:t,scrollDistance:t===Y?3:-3}),requestAnimationFrame(e)}};e()},[V]),l(()=>{T({type:B,width:S,height:b})},[S,b]),l(()=>{void 0!==$&&t.sort($)},[t,$]),l(()=>{void 0!==F&&t.group(F)},[t,F]),l(()=>{void 0!==z&&t.setGroupState(z)},[t,z]);const U=I?24:0,q=s?c*P:0,K=q+U,J=t.size<=0,Z=J&&w.emptyDisplay||null,j=p("Grid",w.className,Z?"empty":"",J&&!1===w.showHeaderWhenEmpty?"no-header":"");return e.createElement(St.Provider,{value:{dispatch:T,callbackPropsDispatch:G,showContextMenu:A}},e.createElement("div",{style:{position:"relative",height:O,width:W,...i},className:j},s&&0!==c&&e.createElement(Ht,{ref:C,height:q,model:R,colHeaderRenderer:w.colHeaderRenderer}),I&&e.createElement(zt,{ref:E,dataView:t,model:R,filter:L,height:U,style:{position:"absolute",top:q,height:U,width:W}}),e.createElement(k,{defaultStyle:{top:q},style:{top:_(K)}},n=>e.createElement(rn,{dataView:t,model:R,style:n,height:O-K,onFilterChange:D})),Z))}export{wt as Draggable,mn as Grid,K as Selection};
//# sourceMappingURL=index.js.map
